(function() {
  module.exports = function(colorPicker) {
    return {
      Emitter: (require('../modules/Emitter'))(),
      element: null,
      color: null,
      emitOutputFormat: function(format) {
        return this.Emitter.emit('outputFormat', format);
      },
      onOutputFormat: function(callback) {
        return this.Emitter.on('outputFormat', callback);
      },
      activate: function() {
        var _isClicking, hasChild;
        this.element = {
          el: (function() {
            var _classPrefix, _el;
            _classPrefix = colorPicker.element.el.className;
            _el = document.createElement('div');
            _el.classList.add(_classPrefix + "-color");
            return _el;
          })(),
          addClass: function(className) {
            this.el.classList.add(className);
            return this;
          },
          removeClass: function(className) {
            this.el.classList.remove(className);
            return this;
          },
          height: function() {
            return this.el.offsetHeight;
          },
          add: function(element) {
            this.el.appendChild(element);
            return this;
          },
          previousColor: null,
          setColor: function(smartColor) {
            var _color;
            _color = smartColor.toRGBA();
            if (this.previousColor && this.previousColor === _color) {
              return;
            }
            this.el.style.backgroundColor = _color;
            return this.previousColor = _color;
          }
        };
        colorPicker.element.add(this.element.el);
        setTimeout((function(_this) {
          return function() {
            var _newHeight;
            _newHeight = colorPicker.element.height() + _this.element.height();
            return colorPicker.element.setHeight(_newHeight);
          };
        })(this));
        hasChild = function(element, child) {
          var _parent;
          if (child && (_parent = child.parentNode)) {
            if (child === element) {
              return true;
            } else {
              return hasChild(element, _parent);
            }
          }
          return false;
        };
        _isClicking = false;
        colorPicker.onMouseDown((function(_this) {
          return function(e, isOnPicker) {
            if (!(isOnPicker && hasChild(_this.element.el, e.target))) {
              return;
            }
            e.preventDefault();
            return _isClicking = true;
          };
        })(this));
        colorPicker.onMouseMove(function(e) {
          return _isClicking = false;
        });
        colorPicker.onMouseUp((function(_this) {
          return function(e) {
            if (!_isClicking) {
              return;
            }
            colorPicker.replace(_this.color);
            return colorPicker.element.close();
          };
        })(this));
        colorPicker.onKeyDown((function(_this) {
          return function(e) {
            if (e.which !== 13) {
              return;
            }
            e.stopPropagation();
            return colorPicker.replace(_this.color);
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Alpha;
            Alpha = colorPicker.getExtension('Alpha');
            Alpha.onColorChanged(function(smartColor) {
              _this.element.setColor((function() {
                if (smartColor) {
                  return smartColor;
                } else {
                  return colorPicker.SmartColor.HEX('#f00');
                }
              })());
            });
          };
        })(this));
        setTimeout((function(_this) {
          return function() {
            var Alpha, Format, Return, _currentColor, _formatFormat, _inputColor, _text, setColor;
            Alpha = colorPicker.getExtension('Alpha');
            Return = colorPicker.getExtension('Return');
            Format = colorPicker.getExtension('Format');
            _text = document.createElement('p');
            _text.classList.add(_this.element.el.className + "-text");
            colorPicker.onBeforeOpen(function() {
              return _this.color = null;
            });
            _inputColor = null;
            colorPicker.onInputColor(function(smartColor, wasFound) {
              return _inputColor = wasFound ? smartColor : null;
            });
            _formatFormat = null;
            Format.onFormatChanged(function(format) {
              return _formatFormat = format;
            });
            colorPicker.onInputColor(function() {
              return _formatFormat = null;
            });
            setColor = function(smartColor) {
              var _format, _function, _outputColor, _preferredFormat;
              _preferredFormat = atom.config.get('color-picker.preferredFormat');
              _format = _formatFormat || (_inputColor != null ? _inputColor.format : void 0) || _preferredFormat || 'RGB';
              _function = smartColor.getAlpha() < 1 ? smartColor["to" + _format + "A"] || smartColor["to" + _format] : smartColor["to" + _format];
              _outputColor = (function() {
                if (_inputColor && (_inputColor.format === _format || _inputColor.format === (_format + "A"))) {
                  if (smartColor.equals(_inputColor)) {
                    return _inputColor.value;
                  }
                }
                return _function.call(smartColor);
              })();
              if (_outputColor === _this.color) {
                return;
              }
              if (_inputColor && atom.config.get('color-picker.automaticReplace')) {
                colorPicker.replace(_outputColor);
              }
              _this.color = _outputColor;
              _text.innerText = _outputColor;
              return _this.emitOutputFormat(_format);
            };
            _currentColor = null;
            Alpha.onColorChanged(function(smartColor) {
              setColor(_currentColor = (function() {
                if (smartColor) {
                  return smartColor;
                } else {
                  return colorPicker.SmartColor.HEX('#f00');
                }
              })());
            });
            Format.onFormatChanged(function() {
              return setColor(_currentColor);
            });
            Return.onVisibility(function(visibility) {
              if (visibility) {
                return _this.element.addClass('is--returnVisible');
              } else {
                return _this.element.removeClass('is--returnVisible');
              }
            });
            return _this.element.add(_text);
          };
        })(this));
        return this;
      }
    };
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiL2hvbWUvbm90Y2xlcmsvLmF0b20vcGFja2FnZXMvY29sb3ItcGlja2VyL2xpYi9leHRlbnNpb25zL0NvbG9yLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFLSTtFQUFBLE1BQU0sQ0FBQyxPQUFQLEdBQWlCLFNBQUMsV0FBRDtXQUNiO01BQUEsT0FBQSxFQUFTLENBQUMsT0FBQSxDQUFRLG9CQUFSLENBQUQsQ0FBQSxDQUFBLENBQVQ7TUFFQSxPQUFBLEVBQVMsSUFGVDtNQUdBLEtBQUEsRUFBTyxJQUhQO01BU0EsZ0JBQUEsRUFBa0IsU0FBQyxNQUFEO2VBQ2QsSUFBQyxDQUFBLE9BQU8sQ0FBQyxJQUFULENBQWMsY0FBZCxFQUE4QixNQUE5QjtNQURjLENBVGxCO01BV0EsY0FBQSxFQUFnQixTQUFDLFFBQUQ7ZUFDWixJQUFDLENBQUEsT0FBTyxDQUFDLEVBQVQsQ0FBWSxjQUFaLEVBQTRCLFFBQTVCO01BRFksQ0FYaEI7TUFpQkEsUUFBQSxFQUFVLFNBQUE7QUFDTixZQUFBO1FBQUEsSUFBQyxDQUFBLE9BQUQsR0FDSTtVQUFBLEVBQUEsRUFBTyxDQUFBLFNBQUE7QUFDSCxnQkFBQTtZQUFBLFlBQUEsR0FBZSxXQUFXLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUN0QyxHQUFBLEdBQU0sUUFBUSxDQUFDLGFBQVQsQ0FBdUIsS0FBdkI7WUFDTixHQUFHLENBQUMsU0FBUyxDQUFDLEdBQWQsQ0FBc0IsWUFBRixHQUFnQixRQUFwQztBQUVBLG1CQUFPO1VBTEosQ0FBQSxDQUFILENBQUEsQ0FBSjtVQU9BLFFBQUEsRUFBVSxTQUFDLFNBQUQ7WUFBZSxJQUFDLENBQUEsRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFkLENBQWtCLFNBQWxCO0FBQTZCLG1CQUFPO1VBQW5ELENBUFY7VUFRQSxXQUFBLEVBQWEsU0FBQyxTQUFEO1lBQWUsSUFBQyxDQUFBLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFB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Z0JBQ3hCLElBQUcsVUFBSDtBQUFtQix5QkFBTyxXQUExQjtpQkFBQSxNQUFBO0FBRUsseUJBQU8sV0FBVyxDQUFDLFVBQVUsQ0FBQyxHQUF2QixDQUEyQixNQUEzQixFQUZaOztjQUR3QixDQUFBLENBQUgsQ0FBQSxDQUF6QjtZQURpQixDQUFyQjtZQVFBLE1BQU0sQ0FBQyxlQUFQLENBQXVCLFNBQUE7cUJBQUcsUUFBQSxDQUFTLGFBQVQ7WUFBSCxDQUF2QjtZQUlBLE1BQU0sQ0FBQyxZQUFQLENBQW9CLFNBQUMsVUFBRDtjQUNoQixJQUFHLFVBQUg7dUJBQW1CLEtBQUMsQ0FBQSxPQUFPLENBQUMsUUFBVCxDQUFrQixtQkFBbEIsRUFBbkI7ZUFBQSxNQUFBO3VCQUNLLEtBQUMsQ0FBQSxPQUFPLENBQUMsV0FBVCxDQUFxQixtQkFBckIsRUFETDs7WUFEZ0IsQ0FBcEI7bUJBR0EsS0FBQyxDQUFBLE9BQU8sQ0FBQyxHQUFULENBQWEsS0FBYjtVQTlFTztRQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FBWDtBQStFQSxlQUFPO01BaEtELENBakJWOztFQURhO0FBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4jICBDb2xvciBQaWNrZXIvZXh0ZW5zaW9uczogQ29sb3JcbiMgIFRoZSBlbGVtZW50IHNob3dpbmcgdGhlIGN1cnJlbnQgY29sb3JcbiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgbW9kdWxlLmV4cG9ydHMgPSAoY29sb3JQaWNrZXIpIC0+XG4gICAgICAgIEVtaXR0ZXI6IChyZXF1aXJlICcuLi9tb2R1bGVzL0VtaXR0ZXInKSgpXG5cbiAgICAgICAgZWxlbWVudDogbnVsbFxuICAgICAgICBjb2xvcjogbnVsbFxuXG4gICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgIyAgU2V0IHVwIGV2ZW50cyBhbmQgaGFuZGxpbmdcbiAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAgICAgIyBPdXRwdXQgZm9ybWF0IGV2ZW50XG4gICAgICAgIGVtaXRPdXRwdXRGb3JtYXQ6IChmb3JtYXQpIC0+XG4gICAgICAgICAgICBARW1pdHRlci5lbWl0ICdvdXRwdXRGb3JtYXQnLCBmb3JtYXRcbiAgICAgICAgb25PdXRwdXRGb3JtYXQ6IChjYWxsYmFjaykgLT5cbiAgICAgICAgICAgIEBFbWl0dGVyLm9uICdvdXRwdXRGb3JtYXQnLCBjYWxsYmFja1xuXG4gICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgIyAgQ3JlYXRlIGFuZCBhY3RpdmF0ZSBDb2xvciBlbGVtZW50XG4gICAgIyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgIGFjdGl2YXRlOiAtPlxuICAgICAgICAgICAgQGVsZW1lbnQgPVxuICAgICAgICAgICAgICAgIGVsOiBkbyAtPlxuICAgICAgICAgICAgICAgICAgICBfY2xhc3NQcmVmaXggPSBjb2xvclBpY2tlci5lbGVtZW50LmVsLmNsYXNzTmFtZVxuICAgICAgICAgICAgICAgICAgICBfZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50ICdkaXYnXG4gICAgICAgICAgICAgICAgICAgIF9lbC5jbGFzc0xpc3QuYWRkIFwiI3sgX2NsYXNzUHJlZml4IH0tY29sb3JcIlxuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBfZWxcbiAgICAgICAgICAgICAgICAjIFV0aWxpdHkgZnVuY3Rpb25zXG4gICAgICAgICAgICAgICAgYWRkQ2xhc3M6IChjbGFzc05hbWUpIC0+IEBlbC5jbGFzc0xpc3QuYWRkIGNsYXNzTmFtZTsgcmV0dXJuIHRoaXNcbiAgICAgICAgICAgICAgICByZW1vdmVDbGFzczogKGNsYXNzTmFtZSkgLT4gQGVsLmNsYXNzTGlzdC5yZW1vdmUgY2xhc3NOYW1lOyByZXR1cm4gdGhpc1xuXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiAtPiBAZWwub2Zmc2V0SGVpZ2h0XG5cbiAgICAgICAgICAgICAgICAjIEFkZCBhIGNoaWxkIG9uIHRoZSBDb2xvciBlbGVtZW50XG4gICAgICAgICAgICAgICAgYWRkOiAoZWxlbWVudCkgLT5cbiAgICAgICAgICAgICAgICAgICAgQGVsLmFwcGVuZENoaWxkIGVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNcblxuICAgICAgICAgICAgICAgICMgU2V0IHRoZSBDb2xvciBlbGVtZW50IGJhY2tncm91bmQgY29sb3JcbiAgICAgICAgICAgICAgICBwcmV2aW91c0NvbG9yOiBudWxsXG4gICAgICAgICAgICAgICAgc2V0Q29sb3I6IChzbWFydENvbG9yKSAtPlxuICAgICAgICAgICAgICAgICAgICBfY29sb3IgPSBzbWFydENvbG9yLnRvUkdCQSgpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBpZiBAcHJldmlvdXNDb2xvciBhbmQgQHByZXZpb3VzQ29sb3IgaXMgX2NvbG9yXG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBAZWwuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gX2NvbG9yXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBAcHJldmlvdXNDb2xvciA9IF9jb2xvclxuICAgICAgICAgICAgY29sb3JQaWNrZXIuZWxlbWVudC5hZGQgQGVsZW1lbnQuZWxcblxuICAgICAgICAjICBJbmNyZWFzZSBDb2xvciBQaWNrZXIgaGVpZ2h0XG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBzZXRUaW1lb3V0ID0+XG4gICAgICAgICAgICAgICAgX25ld0hlaWdodCA9IGNvbG9yUGlja2VyLmVsZW1lbnQuaGVpZ2h0KCkgKyBAZWxlbWVudC5oZWlnaHQoKVxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLmVsZW1lbnQuc2V0SGVpZ2h0IF9uZXdIZWlnaHRcblxuICAgICAgICAjICBTZXQgb3IgcmVwbGFjZSBDb2xvciBvbiBjbGlja1xuICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAgICAgaGFzQ2hpbGQgPSAoZWxlbWVudCwgY2hpbGQpIC0+XG4gICAgICAgICAgICAgICAgaWYgY2hpbGQgYW5kIF9wYXJlbnQgPSBjaGlsZC5wYXJlbnROb2RlXG4gICAgICAgICAgICAgICAgICAgIGlmIGNoaWxkIGlzIGVsZW1lbnRcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGhhc0NoaWxkIGVsZW1lbnQsIF9wYXJlbnRcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcblxuICAgICAgICAgICAgX2lzQ2xpY2tpbmcgPSBub1xuXG4gICAgICAgICAgICBjb2xvclBpY2tlci5vbk1vdXNlRG93biAoZSwgaXNPblBpY2tlcikgPT5cbiAgICAgICAgICAgICAgICByZXR1cm4gdW5sZXNzIGlzT25QaWNrZXIgYW5kIGhhc0NoaWxkIEBlbGVtZW50LmVsLCBlLnRhcmdldFxuICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgICAgICAgICAgICAgIF9pc0NsaWNraW5nID0geWVzXG5cbiAgICAgICAgICAgIGNvbG9yUGlja2VyLm9uTW91c2VNb3ZlIChlKSAtPlxuICAgICAgICAgICAgICAgIF9pc0NsaWNraW5nID0gbm9cblxuICAgICAgICAgICAgY29sb3JQaWNrZXIub25Nb3VzZVVwIChlKSA9PlxuICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgX2lzQ2xpY2tpbmdcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5yZXBsYWNlIEBjb2xvclxuICAgICAgICAgICAgICAgIGNvbG9yUGlja2VyLmVsZW1lbnQuY2xvc2UoKVxuXG4gICAgICAgICMgIFNldCBvciByZXBsYWNlIENvbG9yIG9uIGtleSBwcmVzcyBlbnRlclxuICAgICAgICAjIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgICAgICAgY29sb3JQaWNrZXIub25LZXlEb3duIChlKSA9PlxuICAgICAgICAgICAgICAgIHJldHVybiB1bmxlc3MgZS53aGljaCBpcyAxM1xuICAgICAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKClcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5yZXBsYWNlIEBjb2xvclxuXG4gICAgICAgICMgIFNldCBiYWNrZ3JvdW5kIGVsZW1lbnQgY29sb3Igb24gQWxwaGEgY2hhbmdlXG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBzZXRUaW1lb3V0ID0+ICMgd2FpdCBmb3IgdGhlIERPTVxuICAgICAgICAgICAgICAgIEFscGhhID0gY29sb3JQaWNrZXIuZ2V0RXh0ZW5zaW9uICdBbHBoYSdcblxuICAgICAgICAgICAgICAgIEFscGhhLm9uQ29sb3JDaGFuZ2VkIChzbWFydENvbG9yKSA9PlxuICAgICAgICAgICAgICAgICAgICBAZWxlbWVudC5zZXRDb2xvciBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgc21hcnRDb2xvciB0aGVuIHJldHVybiBzbWFydENvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAjIERlZmF1bHQgdG8gI2YwMCByZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGNvbG9yUGlja2VyLlNtYXJ0Q29sb3IuSEVYICcjZjAwJ1xuICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAjICBDcmVhdGUgQ29sb3IgdGV4dCBlbGVtZW50XG4gICAgICAgICMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gICAgICAgICAgICBzZXRUaW1lb3V0ID0+XG4gICAgICAgICAgICAgICAgQWxwaGEgPSBjb2xvclBpY2tlci5nZXRFeHRlbnNpb24gJ0FscGhhJ1xuICAgICAgICAgICAgICAgIFJldHVybiA9IGNvbG9yUGlja2VyLmdldEV4dGVuc2lvbiAnUmV0dXJuJ1xuICAgICAgICAgICAgICAgIEZvcm1hdCA9IGNvbG9yUGlja2VyLmdldEV4dGVuc2lvbiAnRm9ybWF0J1xuXG4gICAgICAgICAgICAgICAgIyBDcmVhdGUgdGV4dCBlbGVtZW50XG4gICAgICAgICAgICAgICAgX3RleHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50ICdwJ1xuICAgICAgICAgICAgICAgIF90ZXh0LmNsYXNzTGlzdC5hZGQgXCIjeyBAZWxlbWVudC5lbC5jbGFzc05hbWUgfS10ZXh0XCJcblxuICAgICAgICAgICAgICAgICMgUmVzZXQgYmVmb3JlIGNvbG9yIHBpY2tlciBvcGVuXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIub25CZWZvcmVPcGVuID0+IEBjb2xvciA9IG51bGxcblxuICAgICAgICAgICAgICAgICMgS2VlcCB0cmFjayBvZiB0aGUgaW5wdXQgY29sb3IgKGZvciBpdHMgZm9ybWF0KVxuICAgICAgICAgICAgICAgIF9pbnB1dENvbG9yID0gbnVsbFxuXG4gICAgICAgICAgICAgICAgY29sb3JQaWNrZXIub25JbnB1dENvbG9yIChzbWFydENvbG9yLCB3YXNGb3VuZCkgLT5cbiAgICAgICAgICAgICAgICAgICAgX2lucHV0Q29sb3IgPSBpZiB3YXNGb3VuZFxuICAgICAgICAgICAgICAgICAgICAgICAgc21hcnRDb2xvclxuICAgICAgICAgICAgICAgICAgICBlbHNlIG51bGxcblxuICAgICAgICAgICAgICAgICMgS2VlcCB0cmFjayBvZiB0aGUgRm9ybWF0IGVsZW1lbnQgZm9ybWF0XG4gICAgICAgICAgICAgICAgX2Zvcm1hdEZvcm1hdCA9IG51bGxcbiAgICAgICAgICAgICAgICBGb3JtYXQub25Gb3JtYXRDaGFuZ2VkIChmb3JtYXQpIC0+IF9mb3JtYXRGb3JtYXQgPSBmb3JtYXRcbiAgICAgICAgICAgICAgICBjb2xvclBpY2tlci5vbklucHV0Q29sb3IgLT4gX2Zvcm1hdEZvcm1hdCA9IG51bGxcblxuICAgICAgICAgICAgICAgICMgU2V0IHRoZSB0ZXh0IGVsZW1lbnQgdG8gY29udGFpbiB0aGUgQ29sb3IgZGF0YVxuICAgICAgICAgICAgICAgIHNldENvbG9yID0gKHNtYXJ0Q29sb3IpID0+XG4gICAgICAgICAgICAgICAgICAgIF9wcmVmZXJyZWRGb3JtYXQgPSBhdG9tLmNvbmZpZy5nZXQgJ2NvbG9yLXBpY2tlci5wcmVmZXJyZWRGb3JtYXQnXG4gICAgICAgICAgICAgICAgICAgIF9mb3JtYXQgPSBfZm9ybWF0Rm9ybWF0IG9yIF9pbnB1dENvbG9yPy5mb3JtYXQgb3IgX3ByZWZlcnJlZEZvcm1hdCBvciAnUkdCJ1xuXG4gICAgICAgICAgICAgICAgICAgICMgVE9ETzogVGhpcyBpcyB2ZXJ5IGZyYWdpbGVcbiAgICAgICAgICAgICAgICAgICAgX2Z1bmN0aW9uID0gaWYgc21hcnRDb2xvci5nZXRBbHBoYSgpIDwgMVxuICAgICAgICAgICAgICAgICAgICAgICAgKHNtYXJ0Q29sb3JbXCJ0byN7IF9mb3JtYXQgfUFcIl0gb3Igc21hcnRDb2xvcltcInRvI3sgX2Zvcm1hdCB9XCJdKVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHNtYXJ0Q29sb3JbXCJ0byN7IF9mb3JtYXQgfVwiXVxuXG4gICAgICAgICAgICAgICAgICAgICMgSWYgYSBjb2xvciB3YXMgaW5wdXQsIGFuZCB0aGUgdmFsdWUgaGFzbid0IGNoYW5nZWQgc2luY2UsXG4gICAgICAgICAgICAgICAgICAgICMgc2hvdyB0aGUgaW5pdGFsIHZhbHVlIG5vdCB0byBjb25mdXNlIHRoZSB1c2VyLCBidXQgb25seVxuICAgICAgICAgICAgICAgICAgICAjIGlmIHRoZSBpbnB1dCBjb2xvciBmb3JtYXQgaXMgc3RpbGwgdGhlIHNhbWVcbiAgICAgICAgICAgICAgICAgICAgX291dHB1dENvbG9yID0gZG8gLT5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIF9pbnB1dENvbG9yIGFuZCAoX2lucHV0Q29sb3IuZm9ybWF0IGlzIF9mb3JtYXQgb3IgX2lucHV0Q29sb3IuZm9ybWF0IGlzIFwiI3sgX2Zvcm1hdCB9QVwiKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNtYXJ0Q29sb3IuZXF1YWxzIF9pbnB1dENvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBfaW5wdXRDb2xvci52YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF9mdW5jdGlvbi5jYWxsIHNtYXJ0Q29sb3JcblxuICAgICAgICAgICAgICAgICAgICAjIEZpbmlzaCBoZXJlIGlmIHRoZSBfb3V0cHV0Q29sb3IgaXMgdGhlIHNhbWUgYXMgdGhlXG4gICAgICAgICAgICAgICAgICAgICMgY3VycmVudCBjb2xvclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5sZXNzIF9vdXRwdXRDb2xvciBpc250IEBjb2xvclxuXG4gICAgICAgICAgICAgICAgICAgICMgQXV0b21hdGljYWxseSByZXBsYWNlIGNvbG9yIGluIGVkaXRvciBpZlxuICAgICAgICAgICAgICAgICAgICAjIGBhdXRvbWF0aWNSZXBsYWNlYCBpcyB0cnVlLCBidXQgb25seSBpZiB0aGVyZSB3YXMgYW5cbiAgICAgICAgICAgICAgICAgICAgIyBpbnB1dCBjb2xvciBhbmQgaWYgaXQgaXMgZGlmZmVyZW50IGZyb20gYmVmb3JlXG4gICAgICAgICAgICAgICAgICAgIGlmIF9pbnB1dENvbG9yIGFuZCBhdG9tLmNvbmZpZy5nZXQgJ2NvbG9yLXBpY2tlci5hdXRvbWF0aWNSZXBsYWNlJ1xuICAgICAgICAgICAgICAgICAgICAgICAgY29sb3JQaWNrZXIucmVwbGFjZSBfb3V0cHV0Q29sb3JcblxuICAgICAgICAgICAgICAgICAgICAjIFNldCBhbmQgc2F2ZSB0aGUgb3V0cHV0IGNvbG9yXG4gICAgICAgICAgICAgICAgICAgIEBjb2xvciA9IF9vdXRwdXRDb2xvclxuICAgICAgICAgICAgICAgICAgICBfdGV4dC5pbm5lclRleHQgPSBfb3V0cHV0Q29sb3JcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gQGVtaXRPdXRwdXRGb3JtYXQgX2Zvcm1hdFxuXG4gICAgICAgICAgICAgICAgIyBVcGRhdGUgb24gYWxwaGEgY2hhbmdlLCBrZWVwIHRyYWNrIG9mIGN1cnJlbnQgY29sb3JcbiAgICAgICAgICAgICAgICBfY3VycmVudENvbG9yID0gbnVsbFxuXG4gICAgICAgICAgICAgICAgQWxwaGEub25Db2xvckNoYW5nZWQgKHNtYXJ0Q29sb3IpID0+XG4gICAgICAgICAgICAgICAgICAgIHNldENvbG9yIF9jdXJyZW50Q29sb3IgPSBkbyAtPlxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgc21hcnRDb2xvciB0aGVuIHJldHVybiBzbWFydENvbG9yXG4gICAgICAgICAgICAgICAgICAgICAgICAjIERlZmF1bHQgdG8gI2YwMCByZWRcbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgcmV0dXJuIGNvbG9yUGlja2VyLlNtYXJ0Q29sb3IuSEVYICcjZjAwJ1xuICAgICAgICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgICAgICAgICAgICMgV2hlbiBGb3JtYXQgaXMgY2hhbmdlZCwgdXBkYXRlIGNvbG9yXG4gICAgICAgICAgICAgICAgRm9ybWF0Lm9uRm9ybWF0Q2hhbmdlZCAtPiBzZXRDb2xvciBfY3VycmVudENvbG9yXG5cbiAgICAgICAgICAgICAgICAjIFdoZW4gdGhlIGBSZXR1cm5gIGVsZW1lbnQgaXMgdmlzaWJsZSwgYWRkIGEgY2xhc3MgdG8gYWxsb3dcbiAgICAgICAgICAgICAgICAjIHRoZSB0ZXh0IHRvIGJlIHB1c2hlZCB1cCBvciBkb3duIGEgYml0XG4gICAgICAgICAgICAgICAgUmV0dXJuLm9uVmlzaWJpbGl0eSAodmlzaWJpbGl0eSkgPT5cbiAgICAgICAgICAgICAgICAgICAgaWYgdmlzaWJpbGl0eSB0aGVuIEBlbGVtZW50LmFkZENsYXNzICdpcy0tcmV0dXJuVmlzaWJsZSdcbiAgICAgICAgICAgICAgICAgICAgZWxzZSBAZWxlbWVudC5yZW1vdmVDbGFzcyAnaXMtLXJldHVyblZpc2libGUnXG4gICAgICAgICAgICAgICAgQGVsZW1lbnQuYWRkIF90ZXh0XG4gICAgICAgICAgICByZXR1cm4gdGhpc1xuIl19
